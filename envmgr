#!/usr/bin/env bash

# Simple shell script for symlinking all files from .rc dir to home directory
# Also upgrades, cleanups homebrew and similar stuff in single command
# Actually absurdly ugly, but hey, it works! Somehow.

# colors
COLOR_RESET="$(tput sgr0)"
COLOR_GREEN="$(tput setaf 2)"

# source config
# shellcheck disable=SC1091
source "${HOME}/.rc/envmgr.conf"

# Function to symlink dotfiles
# Checking if OS is Linux (GNU coreutils), if not, we assume OS uses BSD utils
symlink() {
  if [[ "${OSTYPE}" == "linux-gnu"* ]]; then
    ln -sfvn "${1}" "${2}"
  else
    ln -sfvh "${1}" "${2}"
  fi
}

# Symlink dotfiles and envmgr from ${HOME}/.rc to ~
install_env() {
  echo -e "${COLOR_GREEN}Deploying environment${COLOR_RESET}"
  cd "${HOME}/.rc" || exit
  echo -e "${COLOR_GREEN}Deploying dotfiles from $(pwd || true) to ${HOME}${COLOR_RESET}"
  if [[ "${OSTYPE}" == "linux-gnu"* ]]; then
    dotdirs=( .config .local/share )
    for dir in "${dotdirs[@]}"; do
      if [[ ! -d ${HOME}/${dir} ]]; then
        mkdir -p "${HOME}/${dir}"
      fi
    done
    dotfiles=("${dotfiles[@]}" "${linuxenv[@]}")
  fi
  for file in "${dotfiles[@]}"; do
    symlink "${HOME}/.rc/.${file}" "${HOME}/.${file}"
  done
  symlink "${HOME}/.rc/envmgr" "${HOME}/.rc/.bin/envmgr"
  cd - >&/dev/null || exit 1
  echo -e "${COLOR_GREEN}Finished deploying dotfiles${COLOR_RESET}"
  echo -e "${COLOR_GREEN}Installing vim plugins${COLOR_RESET}"
  vim +PlugInstall +qall
  echo -e "${COLOR_GREEN}Finished installing vim plugins${COLOR_RESET}"
}

# Install mise and tools (python, node, ruby, golang)
# TODO: detect last version automatically
# TODO: verify downloaded binary against shasum
install_devenv() {
  # install mise
  echo -e "${COLOR_GREEN}Installing mise${COLOR_RESET}"
  # detect if it's already installed, if yes, just do self-update
  if [[ -f ${HOME}/.local/bin/mise ]]; then
    mise self-update
  else
    # if not, download
    # detect os
    case ${OSTYPE} in
        "linux-gnu"*) mise_system="linux" ;;
        "darwin"*) mise_system="macos" ;;
        *) echo "Unable to detect supported operating system" || die ;;
    esac
    # detect arch since naming is non-standard
    case $(uname -m) in
        "x86_64"*) mise_architecture="x64" ;;
        "arm64"*) mise_architecture="arm64" ;;
        *) echo "Unable to detect supported architecture" || die ;;
    esac
    mise_download_url=https://github.com/jdx/mise/releases/download/v2026.2.10/mise-v2026.2.10-"${mise_system}"-"${mise_architecture}"
    echo -e "${COLOR_GREEN}Downloading mise from ${mise_download_url}${COLOR_RESET}"
    curl -L "${mise_download_url}" > "${HOME}/.local/bin/mise"
    chmod +x "${HOME}/.local/bin/mise"
    # init mise, force bash because that's what we default
    eval "$("${HOME}"/.local/bin/mise activate bash || true)"
  fi
  # setup default packages
  for gem in "${gems[@]}"; do
    grep -sq "${gem}" "${HOME}/.default-gems" || echo "${gem}" >> "${HOME}/.default-gems"
  done
  for egg in "${eggs[@]}"; do
    grep -sq "${egg}" "${HOME}/.default-python-packages" || echo "${egg}" >> "${HOME}/.default-python-packages"
  done
  for npm_package in "${npms[@]}"; do
    grep -sq "${npm_package}" "${HOME}/.default-npm-packages" || echo "${npm_package}" >> "${HOME}/.default-npm-packages"
  done
  for go_pkg in "${gopkgs[@]}"; do
    grep -sq "${go_pkg}" "${HOME}/.default-golang-pkgs" || echo "${go_pkg}" >> "${HOME}/.default-golang-pkgs"
  done
  # install default tools
  echo -e "${COLOR_GREEN}Installing default tools${COLOR_RESET}"
  for mise_tool in "${mise_tools[@]}"; do
    mise install "${mise_tool}"
    mise use "${mise_tool}"
  done
  echo -e "${COLOR_GREEN}Finished installing mise${COLOR_RESET}"
}

# Installs homebrew on os x (global, script) and linux (manual, homedir)
# Also installs apps from ${HOME}/.rc/Brewfile
install_homebrew() {
  cd "${HOME}/.rc" || exit
  echo -e "${COLOR_GREEN}Installing homebrew and favourite packages${COLOR_RESET}"
  if hash brew 2>/dev/null; then
    echo "Brew is already installed!"
    else
      if [[ "${OSTYPE}" == "linux-gnu"* ]]; then
        git clone https://github.com/Homebrew/brew "${HOME}/.linuxbrew/Homebrew"
        mkdir "${HOME}/.linuxbrew/bin"
        ln -s "${HOME}/.linuxbrew/Homebrew/bin/brew" "${HOME}/.linuxbrew/bin"
        eval "$("${HOME}"/.linuxbrew/bin/brew shellenv || true)"
      elif [[ "${OSTYPE}" == "darwin"* ]]; then
        # TODO: Migrate to manual install
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh || true)"
        eval "$(/opt/homebrew/bin/brew shellenv || true)"
      fi
  fi
  brew bundle
}

install_kubectl_plugins() {
  cd "${HOME}/.rc" || exit
  echo -e "${COLOR_GREEN}Installing kubectl plugins${COLOR_RESET}"
  if hash kubectl-krew 2>/dev/null; then
    kubectl krew install "${kubectl_plugins}"
  fi
}

install_helm_plugins() {
  cd "${HOME}/.rc" || exit
  echo -e "${COLOR_GREEN}Installing helm plugins${COLOR_RESET}"
  if hash helm 2>/dev/null; then
    helm plugin install "${helm_plugins}"
  fi
}

# Nukes whole dotfiles setup
# TODO: Maybe use shred instead of rm?
env_nuke() {
  echo "Cleaning up env"
  echo "Removing dotfiles symlinks"
  for file in "${dotfiles[@]}"; do
    rm -vf "${HOME}/.${file}"
  done
  echo "Cleaning up devenv"
  #for backwards compatibility
  rm -rvf "${HOME}/.asdf"
  rm -rvf "${HOME}/.local/bin/mise"
  rm -rvf "${HOME}/.local/share/mise"
  rm -rvf "${HOME}/.local/state/mise"
  echo "Removing history"
  rm -vf "${HOME}/.zsh-history"
  rm -vf "${HOME}/.bash_history"
  echo "Removing linuxbrew"
  rm -rf "${HOME}/.linuxbrew"
  echo "Removing dotfiles directory"
  rm -rf "${HOME}/.rc"
}

# Checks for updates in env, homebrew, vim plugins and mac app store
env_housekeeper() {
  echo -e "${COLOR_GREEN}Started housekeeping${COLOR_RESET}"
  echo -e "${COLOR_GREEN}Updating dotfiles repo${COLOR_RESET}"
  git -C "${HOME}/.rc" pull
  echo -e "${COLOR_GREEN}Cleaning up outdated symlinks${COLOR_RESET}"
  find -L "${HOME}" -maxdepth 1 -type l -exec rm -i {} +
  if hash brew 2>/dev/null; then
    echo -e "${COLOR_GREEN}Updating and cleaning up homebrew${COLOR_RESET}"
    brew update
    brew upgrade
    brew cleanup
  fi
  # Update mise
  echo -e "${COLOR_GREEN}Updating mise and mise plugins${COLOR_RESET}"
  if hash mise 2>/dev/null; then
    mise self-update
    mise upgrade --bump
  fi
  if hash kubectl-krew 2>/dev/null; then
    kubectl krew upgrade
  fi
# helm doesn't have any checks for versions, so will always run. Disable for now
#  if hash helm 2>/dev/null; then
#    helm_installed_plugins=$(helm plugin list | tail -n +2 | awk '{print $1}')
#    for plugin in $helm_installed_plugins; do
#      helm plugin update $plugin
#    done
#  fi
  if hash mas 2>/dev/null; then
    echo -e "${COLOR_GREEN}Updating mac app store apps${COLOR_RESET}"
    mas upgrade
  fi
  if hash vim 2>/dev/null; then
    echo -e "${COLOR_GREEN}Updating vim plugins${COLOR_RESET}"
    vim +PlugUpdate +PlugUpgrade +PlugClean +qall
  fi
  echo -e "${COLOR_GREEN}Housekeeping finished${COLOR_RESET}"
}

# Arguments parsing
case "${1}" in
  env) install_env ;;
  devenv) install_devenv ;;
  brew) install_homebrew ;;
  fullenv) install_env && install_devenv && install_homebrew && install_kubectl_plugins && install_helm_plugins ;;
  nuke) env_nuke ;;
  maid) env_housekeeper ;;
  *)
    echo "Command list:"
    echo "env - symlink dotfiles"
    echo "devenv - install mise with plugins"
    echo "brew - install homebrew and packages from bundle"
    echo "fullenv - env, devenv and brew combined"
    echo "nuke - remove (almost) everything installed by envmgr"
    echo "maid - upgrade stuff installed by envmgr"
esac
